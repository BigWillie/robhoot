<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RobHoot â€” Play</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Join -->
  <div id="join-screen" class="screen active">
    <div class="logo">Rob<span>Hoot</span></div>
    <div class="join-form">
      <input type="tel" id="pin-input" placeholder="Game PIN" maxlength="4" inputmode="numeric" autocomplete="off">
      <input type="text" id="name-input" placeholder="Nickname" maxlength="20" autocomplete="off">
      <button class="btn" id="join-btn">Join</button>
      <div id="error-box"></div>
    </div>
  </div>

  <!-- Waiting in Lobby -->
  <div id="waiting-screen" class="screen">
    <div class="logo">Rob<span>Hoot</span></div>
    <h2 id="welcome-msg">You're in!</h2>
    <p class="waiting-msg">Waiting for the host to start...</p>
  </div>

  <!-- Question -->
  <div id="question-screen" class="screen">
    <div class="question-counter" id="q-counter"></div>
    <div class="timer" id="timer">--</div>
    <div class="question-text" id="q-text"></div>
    <div class="options-grid" id="q-options"></div>
  </div>

  <!-- Answered (waiting for reveal) -->
  <div id="answered-screen" class="screen">
    <h2>Answer locked in!</h2>
    <p class="waiting-msg">Waiting for time to run out...</p>
  </div>

  <!-- Result -->
  <div id="result-screen" class="screen">
    <div id="feedback" class="feedback"></div>
    <div id="points" class="points-display"></div>
    <div id="total-score" class="points-display" style="margin-top:0.5rem;opacity:0.7"></div>
    <p class="waiting-msg">Waiting for next question...</p>
  </div>

  <!-- Host Disconnected -->
  <div id="disconnected-screen" class="screen">
    <div class="logo">Rob<span>Hoot</span></div>
    <h2>Host disconnected</h2>
    <p class="waiting-msg">The host has left the game. Please refresh to join a new one.</p>
    <a class="btn no-underline" href="/play.html">Refresh</a>
  </div>

  <!-- Leaderboard -->
  <div id="leaderboard-screen" class="screen">
    <div class="logo">Rob<span>Hoot</span></div>
    <h1>Final Results</h1>
    <div class="leaderboard-list" id="final-lb"></div>
  </div>

  <script>
    const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
    let ws = null;

    const $ = id => document.getElementById(id);
    const screens = document.querySelectorAll('.screen');
    const optionColors = ['option-1', 'option-2', 'option-3', 'option-4'];

    function showScreen(id) {
      screens.forEach(s => s.classList.remove('active'));
      $(id).classList.add('active');
    }

    function showError(msg) {
      $('error-box').innerHTML = `<div class="error-msg">${esc(msg)}</div>`;
      setTimeout(() => $('error-box').innerHTML = '', 3000);
    }

    function connect() {
      ws = new WebSocket(`${proto}//${location.host}/ws/play`);

      ws.onopen = () => {
        // If reconnecting, nothing to do until user joins
      };

      ws.onmessage = (e) => {
        const { type, data } = JSON.parse(e.data);

        switch (type) {
          case 'joined':
            showScreen('waiting-screen');
            $('welcome-msg').textContent = `Welcome, ${data.name}!`;
            break;

          case 'error':
            if ($('join-screen').classList.contains('active')) {
              showError(data.message);
              $('join-btn').disabled = false;
            }
            break;

          case 'question':
            showScreen('question-screen');
            $('q-counter').textContent = `Question ${data.index + 1} of ${data.total}`;
            $('timer').textContent = data.timeLimit;
            $('timer').className = 'timer';
            $('q-text').textContent = data.question;
            renderOptions(data.options);
            break;

          case 'timer':
            $('timer').textContent = data.remaining;
            if (data.remaining <= 5) {
              $('timer').classList.add('warning');
            }
            break;

          case 'answer-received':
            showScreen('answered-screen');
            break;

          case 'result':
            showScreen('result-screen');
            if (data.yourAnswer === data.correct) {
              $('feedback').textContent = 'Correct!';
              $('feedback').className = 'feedback correct';
              $('points').textContent = `+${data.points.toLocaleString()} pts`;
            } else {
              $('feedback').textContent = data.yourAnswer ? 'Wrong!' : 'No answer';
              $('feedback').className = 'feedback wrong';
              $('points').textContent = '+0 pts';
            }
            $('total-score').textContent = `Total: ${data.totalScore.toLocaleString()}`;
            break;

          case 'leaderboard':
            showScreen('leaderboard-screen');
            renderLeaderboard(data.leaderboard);
            break;

          case 'host-disconnected':
            showScreen('disconnected-screen');
            break;
        }
      };

      ws.onclose = () => {
        // If we're past the join screen, show disconnect
        if (!$('join-screen').classList.contains('active')) {
          showScreen('join-screen');
          showError('Disconnected from game');
        }
      };
    }

    function renderOptions(options) {
      $('q-options').innerHTML = options.map((opt, i) =>
        `<button class="option-btn ${optionColors[i]}" data-answer="${i + 1}">${esc(opt)}</button>`
      ).join('');

      $('q-options').querySelectorAll('.option-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          // Disable all buttons
          $('q-options').querySelectorAll('.option-btn').forEach(b => {
            b.disabled = true;
          });
          btn.classList.add('selected');
          ws.send(JSON.stringify({ type: 'answer', data: { answer: parseInt(btn.dataset.answer) } }));
        });
      });
    }

    function renderLeaderboard(lb) {
      $('final-lb').innerHTML = lb.map((p, i) =>
        `<div class="leaderboard-row">
          <div class="leaderboard-rank">${i + 1}</div>
          <div class="leaderboard-name">${esc(p.name)}</div>
          <div class="leaderboard-score">${p.score.toLocaleString()}</div>
        </div>`
      ).join('');
    }

    function esc(str) {
      const d = document.createElement('div');
      d.textContent = str; // This will automatically escape HTML
      return d.innerHTML;
    }

    // Join handler
    $('join-btn').addEventListener('click', () => {
      const pin = $('pin-input').value.trim();
      const name = $('name-input').value.trim();
      if (!pin || !name) {
        showError('Enter PIN and nickname');
        return;
      }
      $('join-btn').disabled = true;
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        connect();
        ws.onopen = () => {
          ws.send(JSON.stringify({ type: 'join', data: { pin, name } }));
        };
        // Re-attach message handler since connect() sets it
        const origOnMessage = ws.onmessage;
        ws.onmessage = (e) => {
          const { type } = JSON.parse(e.data);
          if (type === 'error') {
            $('join-btn').disabled = false;
          }
          origOnMessage(e);
        };
      } else {
        ws.send(JSON.stringify({ type: 'join', data: { pin, name } }));
      }
    });

    // Allow Enter key to submit
    $('pin-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') $('name-input').focus();
    });
    $('name-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') $('join-btn').click();
    });

    // Allow 1-4 keys to select answers
    document.addEventListener('keydown', (e) => {
      const num = parseInt(e.key);
      if (num >= 1 && num <= 4) {
        const btn = $('q-options').querySelector(`.option-btn[data-answer="${num}"]`);
        if (btn && !btn.disabled) btn.click();
      }
    });

    // Auto-fill PIN from QR code URL
    const urlPin = new URLSearchParams(location.search).get('pin');
    if (urlPin) {
      document.getElementById('pin-input').value = urlPin;
    }

    // Connect on load
    connect();
  </script>
</body>
</html>
